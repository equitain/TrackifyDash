<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Trackify Admin Dashboard</title>
<style>
:root{--primary:#2e3b4e;--muted:#95a5a6;--accent:#3498db}
body{margin:0;font-family:Inter,Segoe UI,Arial;height:100vh;background:#f5f6f8}
.dashboard{display:flex;height:100vh}
.sidebar{width:240px;background:var(--primary);color:#fff;padding:18px;box-sizing:border-box}
.sidebar h3{text-align:center;margin:0 0 16px}
.sidebar button{display:block;width:100%;text-align:left;padding:10px;border-radius:6px;border:none;margin-bottom:8px;background:#34495e;color:#fff;cursor:pointer}
.sidebar button.active{background:#3d566e}
.main{flex:1;padding:20px;overflow:auto}
.search-row{display:flex;justify-content:flex-end;margin-bottom:10px}
.search-row input{width:300px;padding:8px}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,0.06)}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
thead th{background:var(--primary);color:#fff;position:sticky;top:0}
tr:hover td{background:#fbfbfb}
.action-btn{padding:6px 8px;border-radius:6px;border:none;color:#fff;margin-right:6px;cursor:pointer}
.editBtn{background:#3498db}.saveBtn{background:#2ecc71}.cancelBtn{background:#95a5a6}
.deleteBtn{background:#e74c3c}.resetBtn{background:#9b59b6}.acceptBtn{background:#27ae60}.rejectBtn{background:#d35400}
.bottom-panel{position:fixed;left:260px;right:20px;bottom:14px;background:#fff;padding:10px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.06);display:flex;justify-content:space-between;align-items:center}
.small{font-size:13px;color:#666}
.group-card{background:#fff;border-radius:8px;padding:12px;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,0.04)}
.group-head{display:flex;justify-content:space-between;align-items:center}
.member-list{margin-top:8px;padding-left:14px;display:none}
.member-item{display:flex;justify-content:space-between;align-items:center;padding:4px 0}
.add-member-row{margin-top:8px;display:flex;gap:8px}
input, select{padding:6px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box}
button{cursor:pointer}
a{color:var(--accent)}
</style>
</head>
<body>
<div class="dashboard">
<aside class="sidebar">
<h3>Admin Panel</h3>
<button data-collection="users" class="active">Users</button>
<button data-collection="groups">Groups</button>
<button data-collection="repairshops">Repairshops</button>
<button data-collection="ShopApplication">Shop Applications</button>
<button id="logoutBtn" style="background:#c0392b">Logout</button>
</aside>

<main class="main">
<h2 id="sectionTitle">Users</h2>
<div class="search-row">
<input id="searchInput" placeholder="Search...">
</div>
<div id="tableContainer"></div>
</main>

<div class="bottom-panel">
<div>
<button id="backupBtn" class="btn-primary">Backup All (exclude admin)</button>
<input id="restoreFile" type="file" accept="application/json" style="display:none">
<button id="restoreBtn" style="margin-left:10px;background:#d35400;color:#fff;border:none;padding:8px;border-radius:6px">Restore from JSON</button>
</div>
<div class="small">Destructive restore requires admin password confirmation.</div>
</div>
</div>

<div id="modalRoot" style="display:none"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAqWEjPKI1mHEnw2zmClSblgTTGI1GY-Ao",
  authDomain: "myfirstfirebase-d549e.firebaseapp.com",
  projectId: "myfirstfirebase-d549e",
  storageBucket: "myfirstfirebase-d549e.appspot.com",
  messagingSenderId: "623028546718",
  appId: "1:623028546718:web:0f6d80318e531cfa321f8f"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

if(localStorage.getItem("trackifyAdmin")!=="true") window.location.href="login.html";

const tableContainer = document.getElementById("tableContainer");
const sectionTitle = document.getElementById("sectionTitle");
const searchInput = document.getElementById("searchInput");

let cachedUsers = [];
let cachedGroups = [];

// Logout
document.getElementById("logoutBtn").addEventListener("click", ()=>{
localStorage.removeItem("trackifyAdmin");
window.location.href="login.html";
});

// ---------------- Preload ----------------
async function preloadData(){
  const snapUsers = await getDocs(collection(db,"users"));
  cachedUsers = snapUsers.docs.map(d=>({id:d.id,...d.data()}));
  const snapGroups = await getDocs(collection(db,"groups"));
  cachedGroups = snapGroups.docs.map(d=>({id:d.id,...d.data()}));
}

// ---------------- Utility ----------------
function isURL(str){ try{ return !!new URL(str);}catch(e){return false;} }
function displayValue(val){ return isURL(val)? `<a href="${val}" target="_blank">${val}</a>` : val; }
function fnameFromID(uid){ const u=cachedUsers.find(u=>u.id===uid); return u? u.fname||u.email : uid; }

// ---------- Fixed timestamp ----------
function humanDate(ts){ 
    try { 
        let d;
        if(ts && ts.seconds !== undefined) {  // Firestore Timestamp
            d = new Date(ts.seconds * 1000);
        } else {
            d = new Date(ts);
        }
        return d.toLocaleString("en-GB", { 
            day: "2-digit", month: "short", year: "numeric", 
            hour: "2-digit", minute: "2-digit", second: "2-digit" 
        });
    } catch(e) { 
        return ts; 
    } 
}

// ---------------- Load Users ----------------
async function loadUsers(){
  await preloadData();
  tableContainer.innerHTML="";
  if(cachedUsers.length===0){ tableContainer.innerHTML="<div style='padding:12px'>No users.</div>"; return; }
  const table = document.createElement("table");
  const thead = document.createElement("thead");
  const trh = document.createElement("tr");
  ["Fname","Email","Group Code","Actions"].forEach(h=>{ const th=document.createElement("th"); th.textContent=h; trh.appendChild(th); });
  thead.appendChild(trh); table.appendChild(thead);
  const tbody = document.createElement("tbody");
  cachedUsers.forEach(u=>{
    const tr=document.createElement("tr"); tr.dataset.docid=u.id;
    const tdF=document.createElement("td"); tdF.textContent=u.fname??""; tr.appendChild(tdF);
    const tdE=document.createElement("td"); tdE.textContent=u.email??""; tr.appendChild(tdE);
    const group = cachedGroups.find(g=>g.createdBy===u.id);
    const tdG=document.createElement("td"); tdG.textContent=group?.inviteCode??""; tr.appendChild(tdG);
    const tdActions=document.createElement("td");
    const saveBtn=document.createElement("button"); saveBtn.className="action-btn saveBtn"; saveBtn.textContent="Save";
    const delBtn=document.createElement("button"); delBtn.className="action-btn deleteBtn"; delBtn.textContent="Delete";
    saveBtn.addEventListener("click", async ()=>{
      await updateDoc(doc(db,"users",u.id),{fname:tdF.textContent,email:tdE.textContent});
      alert("Saved!");
      loadUsers();
    });
    delBtn.addEventListener("click", async ()=>{
      if(confirm("Delete this user?")){ await deleteDoc(doc(db,"users",u.id)); loadUsers(); }
    });
    tdActions.appendChild(saveBtn); tdActions.appendChild(delBtn);
    tr.appendChild(tdActions); tbody.appendChild(tr);
  });
  table.appendChild(tbody); tableContainer.appendChild(table);
}

// ---------------- Groups ----------------
async function loadGroups(){
  await preloadData();
  tableContainer.innerHTML="";
  if(cachedGroups.length===0){ tableContainer.innerHTML="<div style='padding:12px'>No groups.</div>"; return; }
  const container = document.createElement("div");
  cachedGroups.forEach(g=>{
    const card=document.createElement("div"); card.className="group-card";
    const head=document.createElement("div"); head.className="group-head";
    const left=document.createElement("div");
    const groupNameEl=document.createElement("div"); groupNameEl.innerHTML=`<strong>Group: ${g.name||"(no name)"}</strong>`;
    const leaderEl=document.createElement("div");
    const leaderName = fnameFromID(g.createdBy);
    leaderEl.innerHTML=`Leader: <span contenteditable="true">${leaderName}</span>`;
    left.appendChild(groupNameEl); left.appendChild(leaderEl);
    const right=document.createElement("div");
    const saveBtn=document.createElement("button"); saveBtn.className="action-btn saveBtn"; saveBtn.textContent="Save";
    const delBtn=document.createElement("button"); delBtn.className="action-btn deleteBtn"; delBtn.textContent="Delete";
    right.appendChild(saveBtn); right.appendChild(delBtn);
    head.appendChild(left); head.appendChild(right);
    card.appendChild(head);

    const toggleBtn=document.createElement("button"); toggleBtn.textContent="View Option"; toggleBtn.style.marginTop="8px";
    card.appendChild(toggleBtn);
    const memberBox=document.createElement("div"); memberBox.className="member-list";
    (Array.isArray(g.members)?g.members:[]).forEach(m=>{
      const memberItem=document.createElement("div"); memberItem.className="member-item";
      memberItem.textContent=fnameFromID(m);
      const removeBtn=document.createElement("button"); removeBtn.className="action-btn deleteBtn"; removeBtn.textContent="Remove";
      removeBtn.addEventListener("click", async ()=>{
        const newMembers=(Array.isArray(g.members)?g.members:[]).filter(x=>x!==m);
        await updateDoc(doc(db,"groups",g.id),{members:newMembers});
        loadGroups();
      });
      memberItem.appendChild(removeBtn); memberBox.appendChild(memberItem);
    });
    const addRow=document.createElement("div"); addRow.className="add-member-row";
    const select=document.createElement("select");
    cachedUsers.forEach(u=>{ const opt=document.createElement("option"); opt.value=u.id; opt.textContent=u.fname||u.email; select.appendChild(opt); });
    const addBtn=document.createElement("button"); addBtn.className="action-btn saveBtn"; addBtn.textContent="Add";
    addBtn.addEventListener("click", async ()=>{
      const newMemberId=select.value;
      const newMembers=[...(Array.isArray(g.members)?g.members:[]), newMemberId];
      await updateDoc(doc(db,"groups",g.id),{members:newMembers});
      loadGroups();
    });
    addRow.appendChild(select); addRow.appendChild(addBtn);
    memberBox.appendChild(addRow);
    card.appendChild(memberBox);
    toggleBtn.addEventListener("click", ()=>{ memberBox.style.display=memberBox.style.display==="none"?"block":"none"; });

    saveBtn.addEventListener("click", async ()=>{
      const leaderValue=head.querySelector("span").textContent.trim();
      const leaderObj=cachedUsers.find(u=>u.fname===leaderValue||u.email===leaderValue);
      await updateDoc(doc(db,"groups",g.id),{createdBy:leaderObj?leaderObj.id:g.createdBy});
      alert("Group saved!");
    });
    delBtn.addEventListener("click", async ()=>{
      if(confirm("Delete this group?")){ await deleteDoc(doc(db,"groups",g.id)); loadGroups(); }
    });
    container.appendChild(card);
  });
  tableContainer.appendChild(container);
}

// ---------------- Sidebar switching ----------------
document.querySelectorAll(".sidebar button[data-collection]").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".sidebar button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const col = btn.dataset.collection;
    sectionTitle.textContent = col==="ShopApplication"?"Shop Applications":col==="repairshops"?"Repairshops":capitalize(col);
    if(col==="users") loadUsers();
    else if(col==="groups") loadGroups();
    else loadOtherCollection(col);
  });
});

// ---------------- Other Collections ----------------
async function loadOtherCollection(col){
  await preloadData();
  const snap = await getDocs(collection(db,col));
  tableContainer.innerHTML="";
  if(snap.empty){ tableContainer.innerHTML="<div style='padding:12px'>No data.</div>"; return; }
  const table = document.createElement("table");
  const thead = document.createElement("thead");
  const trh = document.createElement("tr");
  const keys = Object.keys(snap.docs[0].data());
  keys.forEach(k=>{ const th=document.createElement("th"); th.textContent=k; trh.appendChild(th); });
  const actionTh=document.createElement("th"); actionTh.textContent="Actions"; trh.appendChild(actionTh);
  thead.appendChild(trh); table.appendChild(thead);
  const tbody=document.createElement("tbody");
  snap.forEach(d=>{
    const docData=d.data();
    const tr=document.createElement("tr"); tr.dataset.docid=d.id;
    keys.forEach(k=>{
      const td=document.createElement("td");
      if(k.toLowerCase().includes("url")) td.innerHTML = displayValue(docData[k]);
      else if(k.toLowerCase().includes("time") || k.toLowerCase().includes("timestamp")) td.textContent=humanDate(docData[k]);
      else if(k==="userID"||k==="createdBy") td.textContent=fnameFromID(docData[k]);
      else td.textContent=docData[k]??"";
      td.contentEditable="true"; tr.appendChild(td);
    });
    const tdActions=document.createElement("td");
    const saveBtn=document.createElement("button"); saveBtn.className="action-btn saveBtn"; saveBtn.textContent="Save";
    const delBtn=document.createElement("button"); delBtn.className="action-btn deleteBtn"; delBtn.textContent="Delete";
    saveBtn.addEventListener("click", async ()=>{
      const tds=tr.querySelectorAll("td");
      const updated={};
      keys.forEach((k,i)=>{ updated[k]=tds[i].textContent.trim(); });
      await updateDoc(doc(db,col,d.id),updated);
      alert("Saved!");
    });
    delBtn.addEventListener("click", async ()=>{
      if(confirm("Delete this item?")){ await deleteDoc(doc(db,col,d.id)); loadOtherCollection(col); }
    });
    tdActions.appendChild(saveBtn); tdActions.appendChild(delBtn);
    tr.appendChild(tdActions); tbody.appendChild(tr);
  });
  table.appendChild(tbody); tableContainer.appendChild(table);
}

// ---------------- Search ----------------
searchInput.addEventListener("input", ()=>{
  const filter=searchInput.value.toLowerCase();
  const cards=tableContainer.querySelectorAll(".group-card");
  cards.forEach(c=>{ c.style.display=c.textContent.toLowerCase().includes(filter)?"block":"none"; });
});

// Initial load
loadUsers();
function capitalize(s){return s.charAt(0).toUpperCase()+s.slice(1);}
</script>
</body>
</html>
